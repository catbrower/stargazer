(() => {
    'use strict';

    require('angular');

    angular
        .module('StarGazer', []);
})();
(() => {
    'use strict';

    let THREE = require('three');
    let FlyControls = require('three-fly-controls');
    let OrbitControls = require('three-orbit-controls');

    angular
        .module('StarGazer')
        .controller('MapController', ['$scope', '$http', MapController]);

    function MapController($scope, $http) {
        var controlsOn = true;
        var scale = 100;
        var pageSize = 1000;
        var data = [];
        var star_system;
        var loaded, loadedTotal, created, createdTotal;
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

        $scope.loadingDone = false;
        $scope.creatingDone = false;
        $scope.constellationNames = ['Orion', 'Gemini'];
        $scope.constellations = {};

        $scope.getLoaded = function() {
            return Math.round(loaded / loadedTotal * 100);
        };

        $scope.getCreated = function() {
            return Math.round(created / createdTotal * 100);
        };

        $scope.showConstellation = function(name) {
            var constellation = $scope.constellations[name];

            if(!constellation.visible) {
                constellation.visible = true;
                scene.add(constellation.data);
            } else {
                constellation.visible = false;
                scene.remove(scene.getObjectByName(name));
            }
        };

        $scope.returnToEarth = function() {
            camera.position.set(0,0,0);
        };

        var sceneLoaded = function() {
            $scope.loadingDone = true;
            //$("#canvas").css({'display': "block"});

            scene.add(constructStars({data: data}, 0.0015));

            loadScene();

            var thing = function(index) {
                if(index < $scope.constellationNames.length) {
                    getConstellation($scope.constellationNames[index], function() {thing(index + 1)});
                }
            };

            thing(0);

        };

        var constructStars = function(res, size) {
            var amount = res.data[res.data.length - 1].id;
            var positions = new Float32Array(amount * 3);
            var colors = new Float32Array(amount * 3);
            var sizes = new Float32Array(amount);
            var magnitudes = new Float32Array(amount);

            var vertex = new THREE.Vector3();
            var color = new THREE.Color(0xffffff);

            for (var i = 0; i < amount; i++) {
                vertex.x = 0;
                vertex.y = 0;
                vertex.z = 0;
                color.setRGB(0 ,0 ,0);
                magnitudes[i] = 0;
                sizes[i] = 0;
                vertex.toArray(positions, i * 3);
                color.toArray(colors, i * 3);
            }

            for(var i = 0; i < res.data.length; i++) {
                var star = res.data[i];
                vertex.x = star.x * scale;
                vertex.y = star.y * scale;
                vertex.z = star.z * scale;
                color.setRGB(star.r / 255.0, star.g / 255.0, star.b / 255.0);
                magnitudes[i] = star.Hpmag;
                sizes[i] = 0.2;

                vertex.toArray(positions, star.id * 3);
                color.toArray(colors, star.id * 3);
            }

            var star_system_geo = new THREE.BufferGeometry();
            star_system_geo.addAttribute('position', new THREE.BufferAttribute(positions, 3));
            star_system_geo.addAttribute('customColor', new THREE.BufferAttribute(colors, 3));
            star_system_geo.addAttribute('size', new THREE.BufferAttribute(sizes, 1));
            star_system_geo.addAttribute('magnitude', new THREE.BufferAttribute(magnitudes, 1));

            var material = new THREE.ShaderMaterial( {
                uniforms: {
                    amplitude: {value: 1.0},
                    color:     {value: new THREE.Color(0xffffff)},
                    texture:   {value: new THREE.TextureLoader().load("img/lensflare3.png")}
                },
                vertexShader:   document.getElementById('vertexshader').textContent,
                fragmentShader: document.getElementById('fragmentshader').textContent,
                blending:       THREE.AdditiveBlending,
                depthTest:      false,
                transparent:    true
            });

            star_system = new THREE.Points(star_system_geo, material);

            $scope.creatingDone = true;
            return star_system;
        };

        //Asynxchronously load star data in chunks
        var getStar = function(cur, max) {
            $http.get("http://localhost:3000/api/get_hip/" + pageSize + "/" + cur).then(
                function success(res) {
                    data = data.concat(res.data);
                    loaded = data.length;

                    if(cur < max) {
                        getStar(cur += 1, max);
                    } else {
                        sceneLoaded();
                    }
                }, function fail(res) {
                    console.log(res);
                }
            );
        };

        var getConstellation = function(name, cb) {
            $http.get("http://localhost:3000api/constellation/" + name).then(
                function success(res) {
                    var geometry = new THREE.Geometry();
                    var material = new THREE.LineBasicMaterial({color: 0xff00ff});

                    var pos = star_system.geometry.attributes.position.array;
                    res.data.forEach(function(item) {
                        var i = parseInt(item.starA);
                        var j = parseInt(item.starB);
                        var a = {x: pos[i*3], y: pos[i*3 + 1], z: pos[i*3 + 2]};
                        var b = {x: pos[j*3], y: pos[j*3 + 1], z: pos[j*3 + 2]};

                        geometry.vertices.push(
                            new THREE.Vector3(a.x, a.y, a.z),
                            new THREE.Vector3(b.x, b.y, b.z)
                        );
                    });

                    var line = new THREE.LineSegments(geometry, material);
                    line.name = name;
                    $scope.constellations[name] = {name: name, visible: false, data: line};

                    if(cb) {
                        cb();
                    }
                }, function fail(res) {
                    console.log(res);
                }
            )
        };

        var loadScene = function() {
            var renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
            renderer.setClearColor (0x000000, 1);
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            // controls
            window.controls = new FlyControls( camera );
            window.controls.movementSpeed = 1000;
            window.controls.domElement = renderer.domElement;
            window.controls.rollSpeed = Math.PI / 10;
            window.controls.autoForward = false;
            window.controls.dragToLook = false;

            var clock = new THREE.Clock();
            var render = function () {
                requestAnimationFrame( render );

                var delta = clock.getDelta();

                if(controlsOn) {
                    window.controls.movementSpeed = 0.33 * scale;
                    window.controls.update(delta);
                }

                var time = Date.now() * 0.005;

                var geometry = star_system.geometry;
                var attributes = geometry.attributes;

                for (var i = 0; i < attributes.size.array.length; i++) {
                    var mag = attributes.magnitude.array[i];
                    var v = (mag * Math.sin(0.1 * i + time) / 100.0);
                    //attributes.size.array[i] = Math.pow(0 - mag, 10)  / 1000000000.0;
                    attributes.size.array[i] = (mag * Math.sin(0.1 * i + time)) / 10;
                }

                attributes.size.needsUpdate = true;

                renderer.render(scene, camera);
            };

            render();
        };

        $http.get("http://localhost:3000/api/hip_count").then(
            function success(res) {
                loadedTotal = res.data;
                getStar(1, res.data / pageSize);
            }, function fail(res) {
                $scope.count = res;
            }
        );
    }

})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9hcHAuanMiLCJtYXAvbWFwLmNvbnRyb2xsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1BBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKCgpID0+IHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICByZXF1aXJlKCdhbmd1bGFyJyk7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ1N0YXJHYXplcicsIFtdKTtcbn0pKCk7IiwiKCgpID0+IHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBsZXQgVEhSRUUgPSByZXF1aXJlKCd0aHJlZScpO1xuICAgIGxldCBGbHlDb250cm9scyA9IHJlcXVpcmUoJ3RocmVlLWZseS1jb250cm9scycpO1xuICAgIGxldCBPcmJpdENvbnRyb2xzID0gcmVxdWlyZSgndGhyZWUtb3JiaXQtY29udHJvbHMnKTtcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgnU3RhckdhemVyJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ01hcENvbnRyb2xsZXInLCBbJyRzY29wZScsICckaHR0cCcsIE1hcENvbnRyb2xsZXJdKTtcblxuICAgIGZ1bmN0aW9uIE1hcENvbnRyb2xsZXIoJHNjb3BlLCAkaHR0cCkge1xuICAgICAgICB2YXIgY29udHJvbHNPbiA9IHRydWU7XG4gICAgICAgIHZhciBzY2FsZSA9IDEwMDtcbiAgICAgICAgdmFyIHBhZ2VTaXplID0gMTAwMDtcbiAgICAgICAgdmFyIGRhdGEgPSBbXTtcbiAgICAgICAgdmFyIHN0YXJfc3lzdGVtO1xuICAgICAgICB2YXIgbG9hZGVkLCBsb2FkZWRUb3RhbCwgY3JlYXRlZCwgY3JlYXRlZFRvdGFsO1xuICAgICAgICB2YXIgc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcbiAgICAgICAgdmFyIGNhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSggNzUsIHdpbmRvdy5pbm5lcldpZHRoL3dpbmRvdy5pbm5lckhlaWdodCwgMC4xLCAxMDAwICk7XG5cbiAgICAgICAgJHNjb3BlLmxvYWRpbmdEb25lID0gZmFsc2U7XG4gICAgICAgICRzY29wZS5jcmVhdGluZ0RvbmUgPSBmYWxzZTtcbiAgICAgICAgJHNjb3BlLmNvbnN0ZWxsYXRpb25OYW1lcyA9IFsnT3Jpb24nLCAnR2VtaW5pJ107XG4gICAgICAgICRzY29wZS5jb25zdGVsbGF0aW9ucyA9IHt9O1xuXG4gICAgICAgICRzY29wZS5nZXRMb2FkZWQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKGxvYWRlZCAvIGxvYWRlZFRvdGFsICogMTAwKTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuZ2V0Q3JlYXRlZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoY3JlYXRlZCAvIGNyZWF0ZWRUb3RhbCAqIDEwMCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLnNob3dDb25zdGVsbGF0aW9uID0gZnVuY3Rpb24obmFtZSkge1xuICAgICAgICAgICAgdmFyIGNvbnN0ZWxsYXRpb24gPSAkc2NvcGUuY29uc3RlbGxhdGlvbnNbbmFtZV07XG5cbiAgICAgICAgICAgIGlmKCFjb25zdGVsbGF0aW9uLnZpc2libGUpIHtcbiAgICAgICAgICAgICAgICBjb25zdGVsbGF0aW9uLnZpc2libGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHNjZW5lLmFkZChjb25zdGVsbGF0aW9uLmRhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdGVsbGF0aW9uLnZpc2libGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzY2VuZS5yZW1vdmUoc2NlbmUuZ2V0T2JqZWN0QnlOYW1lKG5hbWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUucmV0dXJuVG9FYXJ0aCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnNldCgwLDAsMCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHNjZW5lTG9hZGVkID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAkc2NvcGUubG9hZGluZ0RvbmUgPSB0cnVlO1xuICAgICAgICAgICAgLy8kKFwiI2NhbnZhc1wiKS5jc3MoeydkaXNwbGF5JzogXCJibG9ja1wifSk7XG5cbiAgICAgICAgICAgIHNjZW5lLmFkZChjb25zdHJ1Y3RTdGFycyh7ZGF0YTogZGF0YX0sIDAuMDAxNSkpO1xuXG4gICAgICAgICAgICBsb2FkU2NlbmUoKTtcblxuICAgICAgICAgICAgdmFyIHRoaW5nID0gZnVuY3Rpb24oaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBpZihpbmRleCA8ICRzY29wZS5jb25zdGVsbGF0aW9uTmFtZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGdldENvbnN0ZWxsYXRpb24oJHNjb3BlLmNvbnN0ZWxsYXRpb25OYW1lc1tpbmRleF0sIGZ1bmN0aW9uKCkge3RoaW5nKGluZGV4ICsgMSl9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGluZygwKTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25zdHJ1Y3RTdGFycyA9IGZ1bmN0aW9uKHJlcywgc2l6ZSkge1xuICAgICAgICAgICAgdmFyIGFtb3VudCA9IHJlcy5kYXRhW3Jlcy5kYXRhLmxlbmd0aCAtIDFdLmlkO1xuICAgICAgICAgICAgdmFyIHBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoYW1vdW50ICogMyk7XG4gICAgICAgICAgICB2YXIgY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheShhbW91bnQgKiAzKTtcbiAgICAgICAgICAgIHZhciBzaXplcyA9IG5ldyBGbG9hdDMyQXJyYXkoYW1vdW50KTtcbiAgICAgICAgICAgIHZhciBtYWduaXR1ZGVzID0gbmV3IEZsb2F0MzJBcnJheShhbW91bnQpO1xuXG4gICAgICAgICAgICB2YXIgdmVydGV4ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcbiAgICAgICAgICAgIHZhciBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigweGZmZmZmZik7XG5cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW1vdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICB2ZXJ0ZXgueCA9IDA7XG4gICAgICAgICAgICAgICAgdmVydGV4LnkgPSAwO1xuICAgICAgICAgICAgICAgIHZlcnRleC56ID0gMDtcbiAgICAgICAgICAgICAgICBjb2xvci5zZXRSR0IoMCAsMCAsMCk7XG4gICAgICAgICAgICAgICAgbWFnbml0dWRlc1tpXSA9IDA7XG4gICAgICAgICAgICAgICAgc2l6ZXNbaV0gPSAwO1xuICAgICAgICAgICAgICAgIHZlcnRleC50b0FycmF5KHBvc2l0aW9ucywgaSAqIDMpO1xuICAgICAgICAgICAgICAgIGNvbG9yLnRvQXJyYXkoY29sb3JzLCBpICogMyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCByZXMuZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBzdGFyID0gcmVzLmRhdGFbaV07XG4gICAgICAgICAgICAgICAgdmVydGV4LnggPSBzdGFyLnggKiBzY2FsZTtcbiAgICAgICAgICAgICAgICB2ZXJ0ZXgueSA9IHN0YXIueSAqIHNjYWxlO1xuICAgICAgICAgICAgICAgIHZlcnRleC56ID0gc3Rhci56ICogc2NhbGU7XG4gICAgICAgICAgICAgICAgY29sb3Iuc2V0UkdCKHN0YXIuciAvIDI1NS4wLCBzdGFyLmcgLyAyNTUuMCwgc3Rhci5iIC8gMjU1LjApO1xuICAgICAgICAgICAgICAgIG1hZ25pdHVkZXNbaV0gPSBzdGFyLkhwbWFnO1xuICAgICAgICAgICAgICAgIHNpemVzW2ldID0gMC4yO1xuXG4gICAgICAgICAgICAgICAgdmVydGV4LnRvQXJyYXkocG9zaXRpb25zLCBzdGFyLmlkICogMyk7XG4gICAgICAgICAgICAgICAgY29sb3IudG9BcnJheShjb2xvcnMsIHN0YXIuaWQgKiAzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHN0YXJfc3lzdGVtX2dlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpO1xuICAgICAgICAgICAgc3Rhcl9zeXN0ZW1fZ2VvLmFkZEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc2l0aW9ucywgMykpO1xuICAgICAgICAgICAgc3Rhcl9zeXN0ZW1fZ2VvLmFkZEF0dHJpYnV0ZSgnY3VzdG9tQ29sb3InLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKGNvbG9ycywgMykpO1xuICAgICAgICAgICAgc3Rhcl9zeXN0ZW1fZ2VvLmFkZEF0dHJpYnV0ZSgnc2l6ZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUoc2l6ZXMsIDEpKTtcbiAgICAgICAgICAgIHN0YXJfc3lzdGVtX2dlby5hZGRBdHRyaWJ1dGUoJ21hZ25pdHVkZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUobWFnbml0dWRlcywgMSkpO1xuXG4gICAgICAgICAgICB2YXIgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoIHtcbiAgICAgICAgICAgICAgICB1bmlmb3Jtczoge1xuICAgICAgICAgICAgICAgICAgICBhbXBsaXR1ZGU6IHt2YWx1ZTogMS4wfSxcbiAgICAgICAgICAgICAgICAgICAgY29sb3I6ICAgICB7dmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweGZmZmZmZil9LFxuICAgICAgICAgICAgICAgICAgICB0ZXh0dXJlOiAgIHt2YWx1ZTogbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKS5sb2FkKFwiaW1nL2xlbnNmbGFyZTMucG5nXCIpfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2ZXJ0ZXhzaGFkZXInKS50ZXh0Q29udGVudCxcbiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZyYWdtZW50c2hhZGVyJykudGV4dENvbnRlbnQsXG4gICAgICAgICAgICAgICAgYmxlbmRpbmc6ICAgICAgIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsXG4gICAgICAgICAgICAgICAgZGVwdGhUZXN0OiAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiAgICB0cnVlXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgc3Rhcl9zeXN0ZW0gPSBuZXcgVEhSRUUuUG9pbnRzKHN0YXJfc3lzdGVtX2dlbywgbWF0ZXJpYWwpO1xuXG4gICAgICAgICAgICAkc2NvcGUuY3JlYXRpbmdEb25lID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybiBzdGFyX3N5c3RlbTtcbiAgICAgICAgfTtcblxuICAgICAgICAvL0FzeW54Y2hyb25vdXNseSBsb2FkIHN0YXIgZGF0YSBpbiBjaHVua3NcbiAgICAgICAgdmFyIGdldFN0YXIgPSBmdW5jdGlvbihjdXIsIG1heCkge1xuICAgICAgICAgICAgJGh0dHAuZ2V0KFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9nZXRfaGlwL1wiICsgcGFnZVNpemUgKyBcIi9cIiArIGN1cikudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzdWNjZXNzKHJlcykge1xuICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5jb25jYXQocmVzLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBsb2FkZWQgPSBkYXRhLmxlbmd0aDtcblxuICAgICAgICAgICAgICAgICAgICBpZihjdXIgPCBtYXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdldFN0YXIoY3VyICs9IDEsIG1heCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY2VuZUxvYWRlZCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gZmFpbChyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBnZXRDb25zdGVsbGF0aW9uID0gZnVuY3Rpb24obmFtZSwgY2IpIHtcbiAgICAgICAgICAgICRodHRwLmdldChcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMGFwaS9jb25zdGVsbGF0aW9uL1wiICsgbmFtZSkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzdWNjZXNzKHJlcykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuR2VvbWV0cnkoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGVyaWFsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHtjb2xvcjogMHhmZjAwZmZ9KTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gc3Rhcl9zeXN0ZW0uZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTtcbiAgICAgICAgICAgICAgICAgICAgcmVzLmRhdGEuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IHBhcnNlSW50KGl0ZW0uc3RhckEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGogPSBwYXJzZUludChpdGVtLnN0YXJCKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhID0ge3g6IHBvc1tpKjNdLCB5OiBwb3NbaSozICsgMV0sIHo6IHBvc1tpKjMgKyAyXX07XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IHt4OiBwb3NbaiozXSwgeTogcG9zW2oqMyArIDFdLCB6OiBwb3NbaiozICsgMl19O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBnZW9tZXRyeS52ZXJ0aWNlcy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IzKGEueCwgYS55LCBhLnopLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IzKGIueCwgYi55LCBiLnopXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgbGluZSA9IG5ldyBUSFJFRS5MaW5lU2VnbWVudHMoZ2VvbWV0cnksIG1hdGVyaWFsKTtcbiAgICAgICAgICAgICAgICAgICAgbGluZS5uYW1lID0gbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNvbnN0ZWxsYXRpb25zW25hbWVdID0ge25hbWU6IG5hbWUsIHZpc2libGU6IGZhbHNlLCBkYXRhOiBsaW5lfTtcblxuICAgICAgICAgICAgICAgICAgICBpZihjYikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIGZhaWwocmVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBsb2FkU2NlbmUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciByZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHthbnRpYWxpYXM6IHRydWUsIGFscGhhOiB0cnVlfSk7XG4gICAgICAgICAgICByZW5kZXJlci5zZXRDbGVhckNvbG9yICgweDAwMDAwMCwgMSk7XG4gICAgICAgICAgICByZW5kZXJlci5zZXRTaXplKCB3aW5kb3cuaW5uZXJXaWR0aCwgd2luZG93LmlubmVySGVpZ2h0ICk7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKCByZW5kZXJlci5kb21FbGVtZW50ICk7XG5cbiAgICAgICAgICAgIC8vIGNvbnRyb2xzXG4gICAgICAgICAgICB3aW5kb3cuY29udHJvbHMgPSBuZXcgRmx5Q29udHJvbHMoIGNhbWVyYSApO1xuICAgICAgICAgICAgd2luZG93LmNvbnRyb2xzLm1vdmVtZW50U3BlZWQgPSAxMDAwO1xuICAgICAgICAgICAgd2luZG93LmNvbnRyb2xzLmRvbUVsZW1lbnQgPSByZW5kZXJlci5kb21FbGVtZW50O1xuICAgICAgICAgICAgd2luZG93LmNvbnRyb2xzLnJvbGxTcGVlZCA9IE1hdGguUEkgLyAxMDtcbiAgICAgICAgICAgIHdpbmRvdy5jb250cm9scy5hdXRvRm9yd2FyZCA9IGZhbHNlO1xuICAgICAgICAgICAgd2luZG93LmNvbnRyb2xzLmRyYWdUb0xvb2sgPSBmYWxzZTtcblxuICAgICAgICAgICAgdmFyIGNsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7XG4gICAgICAgICAgICB2YXIgcmVuZGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSggcmVuZGVyICk7XG5cbiAgICAgICAgICAgICAgICB2YXIgZGVsdGEgPSBjbG9jay5nZXREZWx0YSgpO1xuXG4gICAgICAgICAgICAgICAgaWYoY29udHJvbHNPbikge1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29udHJvbHMubW92ZW1lbnRTcGVlZCA9IDAuMzMgKiBzY2FsZTtcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnRyb2xzLnVwZGF0ZShkZWx0YSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmFyIHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDU7XG5cbiAgICAgICAgICAgICAgICB2YXIgZ2VvbWV0cnkgPSBzdGFyX3N5c3RlbS5nZW9tZXRyeTtcbiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7XG5cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGF0dHJpYnV0ZXMuc2l6ZS5hcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWFnID0gYXR0cmlidXRlcy5tYWduaXR1ZGUuYXJyYXlbaV07XG4gICAgICAgICAgICAgICAgICAgIHZhciB2ID0gKG1hZyAqIE1hdGguc2luKDAuMSAqIGkgKyB0aW1lKSAvIDEwMC4wKTtcbiAgICAgICAgICAgICAgICAgICAgLy9hdHRyaWJ1dGVzLnNpemUuYXJyYXlbaV0gPSBNYXRoLnBvdygwIC0gbWFnLCAxMCkgIC8gMTAwMDAwMDAwMC4wO1xuICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnNpemUuYXJyYXlbaV0gPSAobWFnICogTWF0aC5zaW4oMC4xICogaSArIHRpbWUpKSAvIDEwO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXMuc2l6ZS5uZWVkc1VwZGF0ZSA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICByZW5kZXJlci5yZW5kZXIoc2NlbmUsIGNhbWVyYSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByZW5kZXIoKTtcbiAgICAgICAgfTtcblxuICAgICAgICAkaHR0cC5nZXQoXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2hpcF9jb3VudFwiKS50aGVuKFxuICAgICAgICAgICAgZnVuY3Rpb24gc3VjY2VzcyhyZXMpIHtcbiAgICAgICAgICAgICAgICBsb2FkZWRUb3RhbCA9IHJlcy5kYXRhO1xuICAgICAgICAgICAgICAgIGdldFN0YXIoMSwgcmVzLmRhdGEgLyBwYWdlU2l6ZSk7XG4gICAgICAgICAgICB9LCBmdW5jdGlvbiBmYWlsKHJlcykge1xuICAgICAgICAgICAgICAgICRzY29wZS5jb3VudCA9IHJlcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbn0pKCk7XG4iXX0=
